#!/data/data/com.termux/files/usr/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/env"

if [[ ! -f "$ENV_FILE" ]]; then
  echo "缺少 $ENV_FILE ，先从 scripts/env.example 复制一份为 scripts/env"
  exit 1
fi

# shellcheck disable=SC1090
source "$ENV_FILE"

# 防止变量为空导致 rsync 源路径变成 "/"
: "${REPO:?REPO 未设置}"
: "${VAULT:?VAULT 未设置}"

echo "[Pull] git pull..."
cd "$REPO"
git pull "$REMOTE" "$BRANCH"

echo "[Sync] repo -> vault (rsync)..."
rsync -r --delete --no-times --no-perms --omit-dir-times \
  --exclude ".git/" \
  --exclude ".obsidian/plugins/" \
  --exclude ".obsidian/cache/" \
  --exclude ".obsidian/trash/" \
  --exclude ".obsidian/workspace*" \
  --exclude ".obsidian/community-plugins.json" \
  --exclude ".obsidian/core-plugins.json" \
  --exclude ".obsidian/app.json" \
  "$REPO"/ "$VAULT"/

echo "[Done] pull + rsync finished."
