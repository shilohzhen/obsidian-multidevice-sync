#!/data/data/com.termux/files/usr/bin/bash
set -e

# --- é…ç½®åŒºï¼šè¯·ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„è·¯å¾„ ---
VAULT="/storage/emulated/0/Documents/Obsidian/ä½ çš„åº“å"
REPO="$HOME/Obsidian_Sync_repo"
# --------------------------------

cd "$REPO"

echo "== 1. æ‹‰å–é˜²å†²çª =="
git pull --no-edit

echo "== 2. å¤‡ä»½ï¼šRepo -> Vault =="
# é˜²æ­¢ Vault ç¼ºå¤±ç”µè„‘ç«¯æ–°å¢çš„æ–‡ä»¶
rsync -r --no-times --no-perms --omit-dir-times \
  --exclude ".git/" \
  --exclude ".obsidian/plugins/" \
  --exclude ".obsidian/workspace*" \
  "$REPO"/ "$VAULT"/

echo "== 3. ä¸Šä¼ ï¼šVault -> Repo =="
# è¿™é‡Œçš„ rsync ä¸å¸¦ --deleteï¼Œå®ç°å®‰å“ç«¯â€œå®‰å…¨æ¨¡å¼â€ (è¯¯åˆ ä¸å½±å“äº‘ç«¯)
rsync -r --no-times --no-perms --omit-dir-times \
  --exclude ".git/" \
  --exclude ".obsidian/plugins/" \
  --exclude ".obsidian/workspace*" \
  "$VAULT"/ "$REPO"/

echo "== 4. æäº¤å¹¶æ¨é€ =="
git add .
if ! git diff --cached --quiet; then
  git commit -m "android update: $(date +'%Y-%m-%d %H:%M:%S')"
  git push
  echo "âœ… æ¨é€æˆåŠŸ"
else
  echo "ğŸ‘Œ æ— å˜æ›´ï¼Œè·³è¿‡æ¨é€"
fi
